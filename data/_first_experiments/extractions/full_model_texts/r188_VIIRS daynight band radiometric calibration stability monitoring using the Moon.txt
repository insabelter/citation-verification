Introduction
The Visible Infrared Imaging Radiometer Suite (VIIRS) is one of the key instruments aboard the Suomi National Polar-orbiting Partnership (S-NPP) satellite. It is a passive whiskbroom scanning imaging spectroradiometer, performing measurements from 0.4 to 12.2 μm in 15 reflective solar bands (RSB) including a panchromatic day/night band (DNB) and seven thermal emissive bands  [Schueler et al., 2001]  to help scientists study large-scale global dynamics in the Earth's system of land, oceans, and atmosphere. VIIRS is a follow-on instrument to three existing sensors: the MODerate resolution Imaging Spectroradiometer (MODIS), the Advanced Very High Resolution Radiometer (AVHRR), and the Operational Linescan System (OLS). VIIRS is designed and manufactured by the same instrument vendor as MODIS. Therefore, its design and operation are strongly based on the MODIS heritage  [Barnes et al., 2003; Xiong et al., 2003; Xiong et al., 2014] . DNB is a temperature-controlled charge-coupled device (CCD) that has 672 subpixel detectors along track, which are aggregated on board to create 16 along-track pixels (rows). The CCD covers the required dynamic range by viewing the scene with four detector arrays with three different radiometric gains: high-gain stage (HGS) A, high-gain stage B, midgain stage (MGS), and low-gain stage (LGS). Figure  1  is a sketch of the detector layout for VIIRS DNB, which is mounted adjacent to the visible/near-infrared (VIS/NIR) focal plane assembly (FPA) shown on the right. The CCD sensor operates in time delay integration (TDI) mode, 205 times for HGS and 3 times for MGS, in the along-scan direction to increase the signal-to-noise ratio (SNR). Redundant high gain A (HGA) and high gain B (HGB) further improve the signal. The images of subpixel detectors are then aggregated into 32 aggregation modes on each side of nadir in the along-scan direction. The details on the DNB subpixel aggregation can be found elsewhere  [Mills, 2010] . The VIIRS DNB was originally designed to produce imagery of clouds continuously for the day, night, and twilight scenes. Now its applications have been expanded to many others related to nighttime imaging. radiances that span a vast dynamic range from 3.0 × 10 À5 W m À2 sr À1 to 200 W m À2 sr À1 with enhanced spatial resolution of 750 m across the entire swath of 3040 km wide. The key design specification of DNB is summarized in Table  1 . While OLS is not radiometrically calibrated, the absolute calibration requirement specification for the DNB is 5% at half maximum radiance and 10% at maximum radiance  [Geis et al., 2012] . The DNB sensor data record (SDR) of Earth view (EV) scene radiance is converted from the detector response in digital number (DN) using the calibrated detector gain coefficient or F factor. The calibration of the DNB LGS uses the solar diffuser (SD) view, and the procedure is similar to the one used for the other RSBs  [Lei et al., 2015a; Lei et al., 2015b] . As has been demonstrated for other RSBs as well, the Moon can be used as a source to independently perform the calibration and track the stability of the SD calibration  [Xiong et al., 2015] . In our study, the RSB lunar calibration algorithm is extended to DNB with the DNB LGS F factor calculated from the lunar images captured during VIIRS scheduled lunar calibrations. The VIIRS design incorporates a rotating telescope assembly (RTA) that can protect the main optical elements from on-orbit contamination  [Weiss, 2011] . Due to tungsten contamination on the coating of the RTA mirrors, the S-NPP VIIRS has experienced strong wavelength-dependent throughput degradation since launch  [Barrie et al., 2012] . In addition to causing the decrease of the signal level and then SNR, the relative spectral response function (RSR) of VIIRS bands is altered by the degradation. Because the spectra of the SD calibration and lunar calibration are different, the on-orbit change of the DNB RSR is expected to introduce deviation between the detector gain changes tracked by SD calibration and lunar calibration. In this paper, the deviation is estimated and verified by the measurement.    [Mills, 2010] . Journal of Geophysical Research: Atmospheres

DNB LGS Calibration and Calibration Methodology
The DNB gain stages are automatically selected for EV images depending on the radiance level of each pixel. The gain stage information is recorded on a pixel level. For a given pixel, which can be operated at any of the three gain stages, the equation that yields DNB top-of-atmosphere radiance is L DNB ¼ F LGS;LUT Á P 2 i¼0 c i;LUT Ádn i DNB RVS DNB;LUT ; (1) where the LGS F factor F LGS,LUT , the background DN offset,LUT , and the adjustment coefficients c i,LUT are regularly updated as look-up tables (LUT). Here dn DNB is background-subtracted detector response DN DNB À DN offset,LUT . The F factor is half angle mirror (HAM) side, detector, and aggregation mode dependent. In operation, linear equation is used so c 0 and c 2 are set to 0. Then c 1 is simply the gain ratio of the three gain stages relative to the LGS. This means that c 1 is a fixed at 1 for LGS. The typical values of c 1 are 0.0026 for MGS and 5.80 × 10 À6 for HGS, respectively. The strategies to calibrate these parameters are discussed elsewhere  [Lee et al., 2014; Lee et al., 2015; Liao et al., 2013] . RVS DNB is the response versus scan angle (RVS) for DNB, which is measured prelaunch and provided as LUT. A notable difference between the DNB and other RSBs is that the DNB SDR radiance is reported as the integrated radiance within its RSR, while the other RSBs use spectral radiance. The spectral radiance is defined as the radiance divided by the effective bandwidth. When the on-orbit RSR change exists, the impact of on-orbit RSR change to the F factor defined by radiance and the spectral radiance will be different, especially for DNB whose bandwidth is relatively wider.

SD Calibration
During a period when the satellite approaches the South Pole, SD is fully illuminated by the Sun. The SD calibration compares the expected radiance on the SD, L SD , to the background-subtracted detector response dn SD . For each orbit, the DNB LGS F factor is computed for each HAM side, aggregation mode, and detector as follows F LGS ¼ L SD dn SD HAM; agg; det ð Þ ÁRVS SD ¼ ∫ E SUN;λ ÁRSR λ ÁBRDF λ Áτ λ ÁH λ ÁdλÁ cosθ inc dn SD HAM; agg; det ð Þ ÁRVS SD ; (2) where dn SD = DN SD À DN bkgd . The DN bkgd is derived from data of space view (SV) sector of the same scan as DN SD is acquired. L SD is radiance reflected from the SD, and E SUN,λ is the spectral irradiance of the Sun at the sensor. RSR λ is the relative spectral response of DNB. Bidirectional reflectance distribution function BRDF λ and τ λ are the wavelength-dependent bidirectional reflectance distribution function and the transmission of the SD screen, H λ , the so-called H factor, is the degradation of the SD monitored by an onboard solar diffuser stability monitor  [Fulbright et al., 2012] , and θ inc is the solar zenith angle on SD panel. RVS SD is the RVS at the mirror scan angle of SD with the angle of incidence (AOI) of 60.2°. Again, DNB LGS is calibrated based on the source radiance so there is no RSR normalization term in the denominator as other RSBs. During the SD calibration, the HAM sides (2) and aggregation modes (32) of the data read out from the SD data sector switch from scan to scan for DNB. Since it takes more than 2 × 32 scans to complete a cycle, the SD calibration data from a single orbit does not cover all the combinations. Therefore, the DNB SD F factor is generated on a daily basis with the composite average of F factors from the 14 or 15 orbits within a day. The LUT, including F factor LUT, is updated on a monthly basis for the SDR processing at the NASA that builds upon the MODIS approach and infrastructure for science team support, product generation, and quality assessment.

Lunar Calibration
Given the inherent stability of the lunar reflecting surface, the Moon has been widely used as an independent source for the radiometric and spatial calibration of the remote sensing instruments. VIIRS lunar observations are regularly scheduled primarily to track its RSB radiometric calibration stability  [Patt et al., 2005; Sun and Xiong, 2011] . During the calibration, the Moon is viewed by VIIRS detectors through its SV port. With the instrument coordinate system defined as the Z and X axis in the nadir and track directions, respectively, the SV is located in the Y-Z plane at a nominal angle of 24.325°below the Y axis (measured from the center of the SV port). The angular size of the SV sector is about 0.85°. Therefore, the view through the SV Journal of Geophysical Research: Atmospheres 10.1002/2016JD026372 port forms a cone with a vertex angle of 0.85°. As VIIRS moves along its nearly circular orbit, the cone forms an angular vertex as shown in Figure  2 . The Moon is viewed by the detectors when it passes through this angular vertex. Because the lunar irradiance strongly depends on the illuminating and viewing geometry, especially lunar phase, VIIRS lunar calibration events are scheduled when the phase angle is within a limited range from À51.5°to À50.5°to minimize the brightness variation among calibrations. To ensure that the Moon passes the field of view of VIIRS detectors at this phase range, a spacecraft roll maneuver is usually implemented to change the field of view of the sensor, as is shown in Figure  2 . Since the launch of VIIRS in October 2011, 42 scheduled lunar calibrations have been successfully performed till June 2016. For most of the lunar calibration events, data sector rotation (SR) is applied. This is done by adjusting the data collection timing of the EV data sector so that the images acquired through the SV are read out from the center of the EV data sector. The width the DNB EV nadir aggregation mode is 368 pixels, much wider than the DNB lunar images of nearly 9 pixels. Therefore, the lunar images are consistently read out in aggregation mode 1 at nadir, which makes it possible to calibrate the detector gain change of this aggregation mode. The SR was only applied to lunar calibrations since 2 April 2012 calibration. Therefore, only the data of the subsequent lunar calibrations are processed to calculate DNB lunar F factors. At a phase angle of around À51°, the majority portion of the lunar disk is illuminated. Figure  3  shows a typical DNB 16 × 16 pixels lunar image captured by a scan at the middle time of a randomly selected 30 March 2015 lunar calibration. The horizontal direction corresponds to the along-scan direction, and the vertical direction corresponds to the along-track (cross-scan) direction. The gain stages of these pixels, recorded as 2 for LGS, 1 for MGS, and 0 for HGS, are plotted in Figure  3a . The white pixels then correspond to LGS, and the black pixels correspond to MGS. Clearly, the pixels capturing lights from the lunar disk receive relatively high radiance so their gain stages are automatically switched to LGS. The pixels at the peripheral region receive low radiance and are commonly set at MGS. These pixels spread at a larger extent than the size of the lunar disk because the response of an imaging system is not perfect. The effect is quantified by the system's modulation transfer function or point spread function  [Wang and Xiong, 2014] . Within the region of this image, there is no pixel at HGS. The DNs of the pixels at LGS and MGS are plotted in Figures  3b  and 3c , separately. The raw DN of MGS pixels, mostly at the peripheral region, are larger than the pixels of the main body of the Moon; even their corresponding radiance is smaller. This is because the detector gain at MGS is much larger than the LGS. Figure  3d  shows the radiance of pixel calculated from (1) with the LUTs provided. The stray light correction is not needed at the radiance level of the lunar images  [Mills et al., 2013] . The signals of rows 1 and 16 (top  Journal of Geophysical Research: Atmospheres and bottom rows) are contaminated by the electric crosstalk when they are at MGS, a phenomenon that has been identified at prelaunch characterization. Because of this, the pixels of these two rows are excluded from the lunar data processing.The VIIRS DNB F factor can be defined similar to SD F factor to relate the radiance at sensor L Moon to detector response dn Moon F Moon ¼ L Moon dn Moon ÁRVS SV ¼ I ROLO =Ω B X row;col dn Moon Ác 1 ÁRVS SV ¼ CÁ∫E SUN;λ ÁA λ ÁRSR λ Ádλ Ω B Á X row;col DN Moon À DN offset;LUT À Á Ác 1 ÁRVS SV ; (3) where RVS SV is the sensor RVS at the SV AOI. Ω B is the solid angle (in steradian) of each pixel. For VIIRS, the SV AOI and the SD AOI are the same. For each scan when the complete lunar image is captured by rows 2-15, the summation of dn Moon is performed over rows in track direction and columns in scan direction. When multiple scans are used, the dn summation are averaged over scans. A λ is the disk-equivalent reflectance and is provided by USGS. I ROLO in (3) is the lunar irradiance predicted by USGS RObotic Lunar Observatory (ROLO)  [Kieffer and Stone, 2005; Fulbright et al., 2014] . Its value depends on the detector RSR as well as the illumination and view geometry at the time of lunar calibration. C is a geometrical factor intrinsic to the model calculated by the ephemeris data of the satellite and the Moon. Although the lunar images contain pixels from both MGS and LGS, the c 1 LUT, which is the gain ratio between gain stages, is applied on a pixel level to effectively convert the MGS dn into LGS dn. Also, considering the fact that the contribution from LGS pixels to the total radiance is more than 98.5% for all calibration events, the F Moon calculated from equation (  3 ) is for LGS. The F factors of MGS and HGS cannot be independently produced from the lunar calibration. The absolute uncertainty of the ROLO model prediction can be as large as 5-10% for the short-wavelength bands and even larger for the NIR bands. However, for a given spectral band, the stability of the irradiance predicted by the ROLO model over a limited range of lunar phase angles and libration angles is much smaller  [Stone, 2008] . Since the lunar phase angle is confined within a limited range, the relative uncertainty of the lunar irradiance predicted by the ROLO model for VIIRS scheduled lunar observations is expected to be about 1%. Therefore, lunar calibration can track the on-orbit change of the detector gain with relatively good precision, while overcoming disadvantages attached to SD calibration, such as the error introduced from SD degradation monitoring and BRDF characterization. This has been demonstrated and confirmed by the MODIS and VIIRS RSB lunar calibration  [Xiong et al., 2015] .

Impact of the Modulated RSR to DNB Calibration
A model has been developed to assess and predict sensor throughput degradation due to the tungsten contamination over its entire mission. The model is used to calculate the time-dependent modulated RSR for each spectral band including DNB  [Iona et al., 2012; Lee et al., 2014] . While most of the degradation occurred during the early mission, the modulated RSR should be consistently applied to both SD calibration and lunar calibration, as well as SDR production.For most VIIRS spectral bands, the impact of the modulation to the RSR shape is insignificant. The F factors calculated using the fixed prelaunch RSR and the modulated RSR differ by less than 0.1% in general. Band M1 has larger difference of 0.25%, which is primarily due to its relatively large out-of-band response. The calibration impact due to modulated RSR is, however, much larger for DNB, mostly because it has a broader bandwidth. Figure  4a  shows the RSR measured prelaunch and the modulated RSR at recent time. The on-orbit change of DNB RSR noticeably impacts the radiance received by DNB detector. The effects of the modulated RSR are not the same for the SD and lunar calibration due to differences in solar spectrum E SUN,λ and lunar spectrum E SUN,λ A λ , according to (2) and (3), respectively. Figure  4b  shows the normalized solar and lunar spectra at the VIS/NIR wavelength range. The DNB spectral radiance L is L SD ∞ ∫ H λ ÁE SUN;λ ÁRSR λ Ádλ ∫RSR λ Ádλ (4) Journal of Geophysical Research: Atmospheres 10.1002/2016JD026372 for the SD view and L Moon ∞ ∫ E Sun;λ ÁA λ ÁRSR λ Ádλ ∫ RSR λ Ádλ (5) for the lunar view. The DNB integrated radiance I is then I SUN ∞ ∫ H λ ÁE Sun;λ ÁRSR λ Ádλ (6) for the SD view and I SUN=Moon ∞ ∫ E Sun;λ ÁA λ ÁRSR λ Ádλ (7) for the lunar view. The difference between the spectral radiance L and integrated radiance I is the effective bandwidth of DNB changes over time, which peaks at about day 80 since launch and then gradually decreases from 330.5 nm to 325 nm, as is shown in Figure  4c . The RTA degradation is maximal at around 1 μm and gradually decreases at shorter and longer wavelengths. Because of this, the DNB RSR peak gradually shifts to shorter wavelengths, as is shown in Figure  4d . The center wavelength continuously drifts toward the shorter wavelength range from 707 nm to 687 nm. The impact of the modulated RSR to DNB calibration is reflected from the on-orbit relative change of L and I results, which can be simulated with equations (  4 )-(  7 ). The results are plotted in Figures  4e  and 4f , respectively. The difference between the two trends is the DNB bandwidth change. It explains why the L changes more abruptly than I in the first 80 days and then much less. The simulation demonstrates that the   4 ) and (5) after being normalized to the first date; (f) the integrated radiance calculated from equations (  6 ) and (  7 ) after being normalized to the first date. Journal of Geophysical Research: Atmospheres 10.1002/2016JD026372 detector gain coefficients F factor defined by radiance and spectral radiance will have different trend when the effective bandwidth changes due to RSR change. This effect is generally true for all bands but is more significant for VIIRS DNB due to its larger RSR change. The differences in Figures  4e  and 4f  are also the errors introduced into F factor calculation if the modulated RSR is not updated on orbit or the prelaunch RSR is continuously used. The impact of the RSR change to the SD calibration is largely offset by the degradation of the SD (H factor). This is because the SD degradation is most significant at shorter wavelength range and shifts the peak of the SD reflected solar spectrum to the longer-wavelength range, opposite to the direction of RSR drift.

Results and Discussion
Comparing to solar spectrum, the lunar spectrum has a less steep slope at 500-900 nm region where DNB acquires signal. Therefore, as the simulation results in Figures  4e  and 4f  demonstrate, the change of the modulated RSR induces less change to the spectral radiance or radiance from the lunar calibration than the solar calibration. Since launch till now, the deviation between the two trends has been about 1%. Because the actual detector gain change impacts equations (  4 ) and (  5 ) the same way, the deviation in L simulated by (  4 ) and (  5 ) due to RSR change is also the expected deviation between measured SD F factor and lunar F factor due to RSR change calculated from equations (  2 ) and (3). The RTA degradation was much faster in the mission beginning, and the degradation rate has been decreasing since launch. The majority of RTA mirror darkening and DNB RSR change had already occurred before 2 April 2012 lunar calibration since when the lunar DNB F factors are first calculated, 158 days since the launch of the S-NPP. The deviation between the two F factor trends since then is simulated to be about 0.3%, which is the deviation that can be actually observed. Figure  5a  shows the measured DNB LGS SD and lunar F factors calculated with equation (3) using the prelaunch RSR and modulated RSR, respectively. As mentioned above, VIIRS views the Moon through its SV with the same AOI as the SD, so RVS SD and RVS SV are equal. Thus, the detector gain's change tracked with SD and the Moon should agree with each other. For both SD and lunar calibration, the F factors are calculated using both the prelaunch RSR throughout the mission and the time-dependent modulated RSR. There is considerable offset of 10-15% between the absolute values of the SD and lunar trends. The offset is linked to the uncertainty of the ROLO model irradiance in absolute values. For direct comparison purpose, the SD F factors are normalized to the first on-orbit date, and the lunar F factors are normalized to the SD F factor on 2 April 2012, the first lunar data point in Figure  5a , so that the SD F factor and the normalized lunar F factor are equal at the date. The results are shown in Figure  5b . This normalization removes the error in the temporally invariant components of the absolute values of calibration references between the SD and lunar calibrations. Figure  5c  shows the ratio of the SD F factors and the normalized lunar F factors. There is noticeable seasonal oscillation in the lunar F factor trending of ±0.5%. The same seasonal oscillation pattern has been observed for other RSBs as well  [Eplee et al., 2015; Xiong et al., 2015] . The level of seasonal oscillation ranges from 0.5% to 1%. This is likely caused by the uncertainty of ROLO lunar irradiance model, which is introduced into the lunar F factor through (3). The actual deviation between the two trends is determined to be 0.17% by least squares linear fitting, close to the above simulation of 0.3%. It should be noted that oscillation pattern does not repeat year after year, so we do not apply a semisinusoidal model to simulate the pattern to improve the fitting result. However, it is clear that the differences between the trends of the lunar F factor and SD F factor are extremely small. That is in line with the expectation that both approaches track the detector gain change at the same AOI. Figure  5d  evaluates the impact of the modulated RSR to both the SD and lunar calibrations with the ratios of the F factor calculated with prelaunch RSR and modulated RSR. Most of the difference occurs during the early mission when the mirror throughput degradation is much faster and before the first 2 April 2012 lunar calibration used in the analysis. Overall, the use of modulated RSR increases the SD F factor by 2.7% and lunar F factor by 1.7% since mission beginning. This matches the simulation in Figure  4f , which indicates 3% increase of SD F factor and 2% increase of lunar F factor. This increase will be carried into SD and lunar F factors as error if the modulated RSR is not taken into account or updated on orbit in the SD calibration and lunar calibration. Deviation of 1% between the SD and lunar F factor trending is going to be observed. If the F factor is defined using the spectral radiance instead of radiance, then the impact of the modulated RSR is simulated in Figure  4e . Our analysis confirms that significant on-orbit change of the RSR may have noticeable impact to the calibration. The on-orbit RSR and source spectra should be taken into account together in the calibration. Similarly, the on-orbit RSR and scene spectra should be taken into account in SDR radiance retrieval as well.

Conclusions
The methodology of the VIIRS DNB LGS lunar calibration is presented, and the results and analysis are provided. The change of the detector gain coefficient F factor can be tracked through lunar calibration, and the results are consistent with the SD calibration within ±0.5% for all calibration events since 2 April 2012 when the first lunar DNB F factor can be calculated. Unlike other narrow-band RSBs, the analysis shows that the change of the modulated RSR has much more significant impact to the calibration of the DNB. Also, the impact to the lunar calibration and solar calibration are different due to different source spectra. Taking into account this effect, the difference between the SD and lunar calibration is about 0.3% since 2 April 2012, in terms of the long-term deviation. The seasonal variation observed in lunar calibration result has been attributed to the ROLO lunar irradiance model instead of VIIRS measurement, as is demonstrated by the lunar calibration results of other RSBs as well.