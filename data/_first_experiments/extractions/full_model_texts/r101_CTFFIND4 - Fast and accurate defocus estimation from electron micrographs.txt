Introduction
Estimating the electron microscope's objective lens defocus and astigmatism from micrographs is of great importance in the three-dimensional reconstruction of biological specimens (reviewed by  Cheng et al., 2015) . Many programs are available for this purpose. Of those, CTFFIND3  (Mindell and Grigorieff, 2003)  is widely used and thought to perform well under a range of circumstances  (Marabini et al., 2015) . We present an updated version of this program, called CTFFIND4, which aims to match the quality of results obtained with CTFFIND3 and to do so significantly faster. Like its predecessor, CTFFIND4 models the microscope's contrast transfer function (CTF) as a 2-dimensional function of the spatial frequency vector g: CTF λ, g, Δ f , C s , Δφ = -ω 1 sin χ λ, g ,Δ f , C s , Δφ -ω 2 cos χ λ, g ,Δ f , C s , Δφ (1) where the frequency-dependent phase shift χ is a function of the electron wavelength λ, the objective defocus Δ f and the spherical aberration C s , χ λ, g , Δ f , C s , Δφ = πλ g 2 Δ f - 1 2 λ 2 g 2 C s + Δφ, (2) and Δφ is an additional phase shift introduced by a phase plate, in the absence of which Δφ = 0. ω 2 is the fraction of total contrast attributed to amplitude contrast, arising for example from electrons scattered outside the objective aperture or those removed by energy filtering  (Yonekura et al., 2006) . The value of this parameter depends on the specimen characteristics (e.g. ice thickness, heavy metal stains) as well as microscope properties (e.g. acceleration voltage, diameter of the objective aperture) and must be given by the user. The relative phase contrast is ω 1 = 1 -w 2 2 . Equation 1 can be simplified and made more computationally efficient  (Fernando and Fuller, 2007) : CTF λ, g, Δ f , C s , Δφ, ω 2 = -sin χ λ, g ,Δ f , C s , Δφ, ω 2 (3) with χ λ, g ,Δ f , C s , Δφ, ω 2 = πλ g 2 Δ f - 1 2 λ 2 g 2 C s + Δφ + tan -1 ω 2 / 1 -ω 2 2 , (4) where the tan -1 term can be precomputed, so that evaluating the CTF only requires one trigonometric function call. To account for astigmatism of the objective lens two defocus values, Δ f 1 and Δ f 2 , are defined, which describe the lens' defocus along normal directions: Δ f = 1 2 Δ f 1 + Δ f 2 + ΔΔ f cos 2 α g -α ast , (5) where α g is the angle between g and the X axis in reciprocal space. The astigmatism is defined by its magnitude ΔΔ f = Δ f 1 -Δ f 2 and its polar angle α ast , the angle between the image X axis and the direction along which Δ f = Δ f 1 (Figure  1 ).

User input
By default, input parameter values are given interactively, with a question-answer sequence inspired by that of the IMAGIC image processing package  (van Heel et al., 1996) , including help messages (given in response to "?") and default answers which are updated with the user's previous answers. Alternatively, the user can give the --old-school-input command-line option, in which case CTFFIND4 will accept the same input as CTFFIND3 but use the CTFFIND4 algorithms described here. This feature is meant to facilitate the use of CTFFIND4 in the context of pre-existing scripts and workflows, though it does not allow access to new features such as movie processing or phase shift determination. Aside from the obvious input parameters (micrograph file name, microscope acceleration voltage etc.), the user must choose a number of parameter values (listed in Table  1 ), for which suggested defaults are built in to the program. These default values should be taken as guides only, but may serve as good starting points when searching for optimal input parameters. Optionally, the user may supply pre-computed amplitude spectra (using command-line option --amplitude-spectrum-input), in which case amplitude spectrum calculation (Section 3.1) will be bypassed. Background subtraction (Section 3.2) can also be bypassed by giving --filtered-amplitude-spectrum-input.

Algorithm
CTFFIND4 mostly re-implements CTFFIND3 with a few modifications. To summarize, the algorithm consists of computing an amplitude spectrum from the input micrograph, estimating the spectrum's background, subtracting this from the original spectrum, and evaluating the similarity between theoretical two-dimensional CTF functions and the remaining oscillatory signal. The parameters for the theoretical CTF are varied until the similarity is maximized, yielding an estimate of the microscope's defocus and astigmatism parameters.

Amplitude spectrum
The amplitude spectrum is computed by taking the absolute of the Fourier transform of the whole micrograph (padded to square dimensions if necessary). The amplitude spectrum is then down-sampled to the desired dimensions by Fourier truncation, which discards terms outside a user-defined central part of the Fourier transform of the amplitude spectrum. The size of the decimated amplitude spectrum, N d , is chosen by the user. To lower the computational cost of the scoring function, it should be kept as small as possible (see section 3.3). However, a small spectrum may not describe CTF oscillations accurately enough, leading to increased errors in parameter estimates. This is epecially true in cases of large defocus (for a more quantitative description of this effect, see  Penczek et al., 2014) . The default spectrum size in CTFFIND4 is 512 × 512 pixels, which is sufficient in the majority of cases, but in many instances users may wish to use smaller dimensions (e.g. 256 × 256) for computational efficiency.

Background subtraction
Most of the power in experimental images is concentrated in the lowest spatial frequencies, giving a dominant peak centered at the origin of the amplitude spectrum and a slowdecreasing ramp towards high frequencies, on top of which amplitude oscillations due to the CTF are sometimes barely discernible. To estimate this ramp, both versions of CTFFIND use the same box-convolution algorithm: the down-sampled amplitude spectrum is convoluted in real space with a square boxcar function, and the resulting smooth spectrum is subtracted from the signal. The convolution operation is carried out only at radii corresponding to frequencies greater than g min . Pixels near the origin are left unchanged, so that after subtraction of the smoothed spectrum they are set to 0. In addition, the central 3 pixels in each direction (x and y) are ignored by the convolution kernel, so that any artefacts in the central cross of the amplitude spectrum do not affect the quality of background subtraction.

Scoring function
We use the normalized cross correlation coefficient between the CTF and the experimental, decimated and background-subtracted amplitude spectrum A d as a target function for our search and refinement of CTF parameters: CC = ∑ g min < g ≤ g max A d (g) ⋅ CTF(g) ∑ g min < g ≤ g max A d (g) 2 ⋅ ∑ g min < g ≤ g max CTF(g) 2 (6) The cross-correlation is computed by iterating over all pixels in A d which lie between the radii corresponding to spatial frequencies g min and g max . The computational cost of evaluating this function is therefore proportional to N d 2 ⋅ g max -g min 2 . In some cases CTF oscillations are not clearly detectable above background noise, such that cross-correlation values are low and they do not discriminate sufficiently between the correct (unknown) set of parameter values and alternatives. Because microscopists commonly aim to minimize astigmatism during data collection however, it is often helpful to prefer CTF parameter values which imply lower astigmatism. To this end, the user can place a restraint on ΔΔ f , the amplitude of astigmatism, by specifying ΔΔ f res . The final score S is then: S = CC - ΔΔ f 2 2ΔΔ f res 2 N CC , (7) where N CC is the number of pixels which were included in the computation of CC. The restraint (second) term in Equation  7 will penalize parameter values which imply very astigmatic CTFs and this penalty will be especially significant when CTF oscillations are weak so that CC tends to be small. The strength of the penalty will be greater with lower ΔΔ f res and larger astigmatism ΔΔ f . In CTFFIND4, this restraint can be turned off by setting ΔΔ f res < 0, in which case S = CC. If ΔΔ f res is set to zero by the user, it is internally set to a small value (100 Å, corresponding to a very strong restraint) to avoid division by zero.

Search for astigmatism angle
During execution of CTFFIND3, most of the computation time is spent on an initial 3dimensional exhaustive search over Δ f 1 , Δ f 2 and α ast . To make our program more efficient, we first estimate α ast separately, using an algorithm described by  van Heel et al. (2000) . First, the preprocessed amplitude spectrum A d is mirrored along one of its axes. It is then aligned rotationally against its mirrored self using a 1-dimensional exhaustive search with 5° steps. α ast is then taken to be half of the rotation angle which relates the two mirror images.

Search for defocus values
In the next step, α ast is fixed and an exhaustive 2-dimensional search is done between Δ f min and Δ f max to find the values of Δ f 1 and Δ f 2 which maximize S.

Refinement of astigmatism & defocus value
The final step of the algorithm consists of a 3-dimensional conjugate-gradient maximization of S, which yields the final estimates of the values Δ f 1 , Δ f 2 and α ast .

Processing dose-fractionated movies
Under some circumstances, improved CTF oscillations may be recovered from experimental micrographs by averaging amplitude spectra of movie frames rather than computing the amplitude spectrum from the sum of aligned frames  (Bartesaghi et al., 2014) .  McMullan et al. (2015)  observed a similar phenomenon in their study of Thon rings from amorphous ice and suggested an optimal dose of 4 e -/Å 2 to observe oscillation around 3.7 Å. CTFFIND4 supports CTF estimation from movies by allowing the user to give a stack of frames as input and specify Nf rames , the number of frames to average together before computing amplitude spectra. If the user sets Nf rames = 1, amplitude spectra are computed from each frame and then averaged.

Processing micrographs recorded using phase plates
Volta phase plates  (Danev et al., 2014)  have recently become available commercially. Unlike other phase plate designs, they introduce a phase shift of scattered relative to unscattered electrons which is variable over time/irradiation and may therefore need to be measured during data collection and/or a posteriori from the collected images. We added a phase shift term Δφ to our CTF model (see Equation  2 ), which can be fit to A d simultaneously with Δ f 1 and Δ f 2 so that users may estimate their phase plate's phase shift. If the user specifies that a phase shift should be fit, α ast is estimated first as usual (see Section 3.4), but the exhaustive search is then 3-dimensional Δ f 1 , Δ f 2 , Δφ and the subsequent maximization is 4dimensional (including α ast ).

Outputs
A summary text file is output, to which the final estimates of Δ f 1 , Δ f 2 , α ast and Δφ for each input micrograph are written (one line per micrograph), as well as the final cross-correlation between A d and the fit CTF (Equation  7 ). The other outputs of CTFFIND4 are concerned with giving the user feedback regarding the quality of the fit.

Diagnostic image
A diagnostic image is generated, showing |CTF fit | overlaid onto a version of A d thresholded to improve contrast of the Thon rings (Figure  2 ). This is meant to provide qualitative feedback and relies on the user's expertise to judge whether the fit was satisfactory and/or until which resolution the fit was successful.

Diagnostic fit profile
CTFFIND4 also computes 1D profiles of A d and |CTF fit |, A d 1D and |CTF fit | 1D . In the simple case where ΔΔ f = 0, these are simply radial averages with bin width b, e.g.: A d 1D r i = r i - b 2 < g ≤ r i + b 2 A d (g) r i - b 2 < g ≤ r i + b 2 1 (8) Evaluating these 1D profiles in the case of astigmatic CTF functions ΔΔ f ≠ 0 is not trivial and this problem has been approached by several authors (e.g.  Mallick et al., 2005) . Our approach's first step is to count, for every pixel, the number n of CTF extrema between it and the origin of the amplitude spectrum image. To find the spatial frequencies of CTF extrema requires solving the derivative of Equation 3 with respect to χ, cos χ λ, g , Δ f , C s , Δφ, ω 2 = 0, (9) for which there is an infinite number of solution, exactly n of which are below any given spatial frequency |g|: nπ - π 2 ≤ χ λ, g , Δ f , C s , Δφ, ω 2 ≤ n + 1 π - π 2 , ( 10 ) so that n = 1 π χ λ, g , Δ f , C s , Δφ, ω 2 + 1 2 , (11) where ⌊ ⌋ denotes the floor function. We hold this count in memory as image E (Figure  3 ). This allows the grouping of pixels according to their "position" along the CTF (number of preceding extrema), as opposed to their spatial frequency (distance from the origin) foot_1  and thus average them regardless of astigmatism. Specifically, we wish to compute the 1D profile of A d along the direction of average defocus α mid = α ast + π/4, in bins of width b = 1 pixel centered at frequencies r i indexed by i = 1, …, N d / 2 . To this end we define S(r i ), the set of g vectors which index pixels that can be averaged together into A d 1D r i because they have the same number of preceding extrema [E(g)] and because their assigned CTF fit values are closer to the value of CTF fit along α mid at r i than at any other bin center r j j ≠ i : S r i = g: E g = E r i , α mid CTF fit g -CTF fit r i , α mid < CTF fit g -CTF fit r j , α mid , (12) where we use set-builder notation; {x : p(x)} denotes the set of values of variable x such that p(x) is satisfied, ^ denotes conjunction. The values of A d at pixels within set S(r i ) can then be averaged to give A d 1D r i : A d 1D r i = g ∈ S r i A d g S r i , (13) where | | denotes the cardinality of a set. Similarly for CTF fit : CTF fit 1D r i = g ∈ S r i CTF fit g S r i , (14)

Estimating the quality of fit
In an attempt to provide a quantitative measure of the quality of fit, we implemented a spatial frequency-dependent measure of the correlation between CTF fit 1D and A d 1D , similar to that described by  Huang et al. (2003) . We chose the normalized cross-correlation, computed at intervals delimited by the maxima of CTF fit 1D along α mid : CC f it r = ∑ r max i < r′ ≤ r max i + 1 A d 1D r′ CTF fit r′, α mid , ( 15 ) where we have omitted the usual normalization terms for clarity, and where r max (i) and r max (i + 1) are the frequencies of the CTF extrema immediately preceding and following r. A d 1D , CTF fit and CC fit are output by CTFFIND4 as a text file which can be plotted using an accompanying script (Figure  4 ). In addition, an estimate is made of the highest resolution up to which a "good" fit to A d is obtained. We chose the criterion of CC f it r ≥ 0.75 heuristically for this purpose, with the hope that a criterion based on a statistical significance test may be derived and implemented in future versions of the software.

Benchmarking
In the following paragraphs, CTFFIND versions 3.5 and 4.0.16 were used. Executable binaries and source code for both are available at  http://grigoriefflab.janelia.org/ ctf .

Speed
We expect that the time spent by CTFFIND4 evaluating S, the objective function, is  proportional to N d 2 g max -g min 2 × Δ f max -Δ f min Δ f step + 90 5 whereas for CTFFIND3 it is proportional to N d 2 g max -g min 2 × Δ f max -Δ f min Δ f step + Δ f step Δ f max -Δ f min Other parts of the algorithm (such as the computation of A d ) may also affect the speed-up somewhat. We measured execution times of CTFFIND3 and CTFFIND4 with micrographs of bacteriorhodopsin, which had been used in benchmarking CTFFIND3  (Mindell and Grigorieff, 2003) , as inputs. Using the same parameters as had been used by Mindell and Grigorieff, one would expect a 9-fold speedup in the search over S, but we only observed a 007E 3.7-fold speedup (Table  2 ). We assume that this is because under those circumstances, CTFFIND4 spends proportionally less time evaluating S and more time on other parts of the algorithm. As a separate test we ran both versions on a set of 24 micrographs of 3712 × 3712 pixels (set #3 from the CTF challenge, see below) using the default parameter values listed in Table  1  and 16 CPU threads. Under those circumstances, CTFFIND4 achieved speed-ups of ~ 10fold relative to CTFFIND3 (µ = 9.85, σ = 0.24).

Accuracy
The micrographs of bacteriorhodopsin provide a useful benchmark for the accuracy of defocus parameter estimation because an earlier crystallographic study estimated their defocus parameters. We found that both versions of CTFFIND were similarly accurate, with errors on the order of a few nanometers (Table  2 ). Assuming that CTFFIND3 provides accurate estimates of defocus parameters under most circumstances, we also aimed to ensure that CTFFIND4's estimates closely matched those from CTFFIND3 under a wide range of circumstances, despite the significant algorithmic changes between the two versions. To this end, we ran both versions on all 9 sets of micrographs made available by  Marabini et al. (2015)  as part of the CTF challenge, and computed the percentage difference in estimates of defocus parameters between the two versions. We found discrepancies in defocus estimates were usually below 1%, but that discrepancies in α ast were often large, in the tens of degrees (Table  3 ), presumably because under experimental conditions (high noise) and with low levels of astigmatism (ΔΔ f /Δ f 1 on the order of 2%), this parameter is poorly determined by the Thon rings. Discrepancies In α ast estimates were notably reduced for one of the sets of micrographs (#9), which consisted of simulated images and had the largest mean astigmatism. They were also very low (1.75 degrees on average) when processing bacteriorhodopsin micrographs, which have relatively large amounts of astigmatism (12 to 20% of Δ f 1 ; Table  2 ). In a significant departure from earlier versions, CTFFIND4 does not discard any parts of the input image when computing its amplitude spectrum. We reasoned that this feature, intended mainly to avoid artefacts in the Fourier transform due to sharp features such as photographic film labels or pieces of dust, was no longer necessary, since the vast majority of datasets are no longer recorded on film, and since features such as film labels can be removed by cropping the micrographs with any of the common image processing packages. In fact, we had noticed that when no features such as film labels were present in the input image, and when only some regions of the micrograph contained carbon film, CTFFIND3's algoritm would often discard those regions. This reduced the amplitude of Thon rings and we hypothesized it might also reduce the accuracy of defocus parameter estimates, though we did not test this. In any case we did not see a need to maintain such a feature in new versions of CTFFIND. To test whether including all areas of the input image in the computation of the spectrum would hinder CTF fitting when dealing with photographic films, we also processed set #5 from the CTF challenge  (Marabini et al., 2015) , which consisted of 17 digitized films including film labels. Despite very strong artefacts in the spectra, CTFFIND4's defocus parameter estimates were still within 1% of CTFFIND3's, suggesting our new version may be generally usable, even in those cases.

Quality of fit
To assist in the assessment of its defocus parameter estimates, CTFFIND4 computes an estimate of the maximum resolution at which the agreement between the fit CTF and the experimental signal oscillations is significant (see section 4.3). We chose the threshold for significance (CC fit = 0.75) heuristically with the goal that the provided estimate correlate well with our visual impression of the fit. Testing this metric with the CTF challenge datasets, we found that it generally agreed with our visual estimate of the amplitude of Thon rings above background. For example, it tended to report higher fit resolutions for micrographs with carbon than those without (Table  3 : compare sets #3, with carbon, and #4, without carbon). We have also found that it can help diagnose mis-calibrated runtime parameters. For example, the micrographs of set #9, which were simulated in silica with a significant amount of astigmatism, clearly have Thon rings extending beyond Nyquist frequency, but our CC fit = 0.75 criterion initially indicated a good fit only up to 7.4 Å. When runtime parameters were improved (by removing the restraint on astigmatism, and increasing N d to 512 to avoid CTF aliasing), the mean fit resolution went up to 3.4 Å, and the reported degree of astigmatism (7.6 %) became more consistent with that reported by  Marabini et al. (2015,  see row 9* of Table  3 ). This suggests that the CC fit may be a valid measure of the goodness of fit of the estimated CTF to experimental micrographs. Two defocus values, Δ f 1 and Δ f 2 , and an angle, α ast define an astigmatic CTF. The effective defocus at an arbitrary point g (scattering vector) in reciprocal space is defined by Equation  5 . Adapted from Figure  3  of  Mindell and Grigorieff (2003) . Diagnostic image from micrograph #1 of set #7 of the CTF challenge, output by CTFFIND4 using runtime parameters detailed in Table  3 . The 2-dimensional CTF (CTF fit ) is overlayed onto the preprocessed amplitude spectrum (A d ) up to the radius corresponding to g max . Figure  3 : Image E generated from the CTF fit to micrograph #1 of set #7 of the CTF challenge. At every pixel (corresponding to a spatial frequency vector g), this image records n, the number of preceding CTF extrema (Equation  11 ). Here this value is color-coded, so that pixels at spatial frequencies before the first extremum of the CTF, which have value 0, are displayed in dark blue. Pixels that have 35 or more preceding CTF extrema are shown in dark red. . One would normally solve this by increasing N d , but we restricted ourselves to previously-used parameter values for this experiment (see caption to Table  3  for more details). 

Δ f step
Step size of initial search for defocus (500 Å) ΔΔ f res Astigmatism restraint (100 Å) N f rames Number of frames to average (1)

Δφ min
Lower bound of initial phase shift search (0 rad)

Δφ max
Upper bound of initial phase shift search (3.15 rad)

Δφ step
Step size of initial phase shift search (0.01 rad) Comparison of defocus parameter estimates from CTFFIND3 and CTFFIND4 to those obtained by crystallographic refinement of bacteriorhodopsin  (Mindell and Grigorieff, 2003) . The differences e between crystallographic values and those obtained by CTFFIND are given in nm Δ f 1 , Δ f 2 and degrees (α ast ). Runtimes are given in seconds and were measured on a single Intel(r) Xeon(r) E5-287W CPU core operating at 3.10 GHz. To make runtimes comparable, the computation of 1D profiles and extra statistics were turned off in CTFFIND4 (they added ~2 seconds to the runtime). Speedups report the ratio of CTFFIND3 to CTFFIND4 runtimes. The following parameters were used: N d = 128, g min CTFFIND3 and CTFFIND4 find very similar defocus parameter values for CTF challenge micrographs. Nine sets of micrographs (described in  Marabini et al., 2015)  were processed with CTFFIND4, using the same parameters as had been used in one of the authors' (N.G.) submission to the CTF challenge using CTFFIND3. -1 = 200Å, g max -1 = 3Å, Δ f min = 1000Å, Δ f max = 10000Å, Δ f step = 500Å. Those parameters were: N d = 256, g min  